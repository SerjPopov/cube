<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cube Timer App</title>
    <script src="vue.js"></script>
    <!-- –î–æ–±–∞–≤–ª–µ–Ω bleManager.js –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å BLE -->
    <script src="bleManager.js"></script>
    <!-- Modular CSS -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css?v=5">
    <link rel="stylesheet" href="css/components.css?v=5">
    <link rel="stylesheet" href="css/animations.css?v=5">
    <link rel="stylesheet" href="css/responsive.css?v=5">
</head>
<body>
    <div id="app" :class="{ 'debug-mode': state.debugMode }">
        <div class="header">
            <h1>üé≤ Cube Timer</h1>
        </div>

        <div class="controls">
            <!-- –®–∞–≥ 1: –ò–∑–º–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É "–ö—É–±–∏–∫ –æ—Ç–∑–æ–≤–∏—Å—å" –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å BLE -->
            <button class="btn btn-summon" @click="fetchDataFromBLE" :disabled="state.bleLoading">
                {{ state.bleLoading ? '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...' : '–ö—É–±–∏–∫ –æ—Ç–∑–æ–≤–∏—Å—å' }}
            </button>
            <button class="btn btn-share" @click="toggleSharePanel">–ö—É–±–∏–∫ –ø–æ–¥–µ–ª–∏—Å—å</button>
            <button class="btn btn-settings" @click="toggleSettingsPanel" :disabled="state.faces.length === 0">–ö—É–±–∏–∫ –Ω–∞—Å—Ç—Ä–æ–π—Å—è</button>
        </div>

        <!-- –®–∞–≥ 4: –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è BLE –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
        <div v-if="state.bleStatus" class="connection-status" :class="{
            'status-connected': state.bleStatus === 'connected',
            'status-connecting': state.bleStatus === 'connecting',
            'status-error': state.bleStatus === 'error'
        }">
            <span v-if="state.bleStatus === 'connecting'">üîµ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫—É–±–∏–∫—É...</span>
            <span v-if="state.bleStatus === 'connected'">üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∫—É–±–∏–∫—É: {{ state.bleDeviceName || '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ' }}</span>
            <span v-if="state.bleStatus === 'error'">üî¥ –û—à–∏–±–∫–∞ BLE: {{ state.bleError || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞' }}</span>
        </div>

        <div v-if="state.error" class="error-message">
            {{ state.error }}
        </div>

        <template v-if="state.faces.length > 0">
            <!-- Top panels —Å–∫—Ä—ã–≤–∞—é—Ç—Å—è –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
            <div class="top-panels" v-if="!editMode">
                <div class="current-face">
                    <h2>üìç –¢–µ–∫—É—â–∞—è –≥—Ä–∞–Ω—å</h2>
                    <div class="current-face-name">{{ getCurrentFaceDisplayName() || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞' }}</div>
                    <div class="current-face-time" v-if="getCurrentFace()">{{ getCurrentFace().deltaValueIntStr }}</div>
                </div>

                <div class="times-panel">
                    <div class="time-item">
                        <div class="time-label">–í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:</div>
                        <div class="time-value">{{ state.extractionTime }}</div>
                    </div>
                    <div class="time-item" v-if="state.resetTime !== 0">
                        <div class="time-label">–í—Ä–µ–º—è –æ–±–Ω—É–ª–µ–Ω–∏—è:</div>
                        <div class="time-value">{{ state.resetTime }}</div>
                    </div>
                </div>
            </div>

            <div class="faces-grid">
                <div 
                    v-for="face in state.faces" 
                    :key="face.id"
                    class="face-card"
                    :class="{
                        active: face.id === state.currentFaceId,
                        editable: editMode
                    }"
                    @click="editMode && openEditForm(face)"
                >
                    <div class="face-id" v-if="state.debugMode">–ì—Ä–∞–Ω—å #{{ face.id }}</div>
                    <div class="face-name">{{ face.customName }}</div>
                    <div class="face-time" v-if="state.debugMode">{{ face.value }}</div>
                    <div class="face-reset-value" v-if="state.debugMode && face.resetValue !== 0">
                        –°–±—Ä–æ—à–µ–Ω–æ: {{ face.resetValue }}
                    </div>
                    <div class="face-delta">
                        {{ face.deltaValueIntStr }}
                    </div>
                </div>
            </div>

            <div class="info-panel" v-if="state.debugMode">
                <h2>‚ÑπÔ∏è –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>
                <div class="info-item">
                    <div class="info-value">{{ state.rawData }}</div>
                </div>
                <div class="info-item" v-if="state.bleDeviceInfo">
                    <div class="info-label">BLE —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:</div>
                    <div class="info-value">{{ state.bleDeviceInfo }}</div>
                </div>
            </div>
        </template>

        <div v-else-if="!state.error" class="no-data">
            <p>üé≤ –ù–∞–∂–º–∏—Ç–µ "–ö—É–±–∏–∫ –æ—Ç–∑–æ–≤–∏—Å—å" –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫—É–±–∏–∫—É —á–µ—Ä–µ–∑ Bluetooth</p>
            <p style="margin-top: 10px; font-size: 0.9rem; opacity: 0.8;">–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ "–ö—É–±–∏–∫ —Ç–µ—Å—Ç" –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ —Ñ–∞–π–ª–∞</p>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
        <transition name="slide-up">
            <div v-if="settingsPanelVisible" class="settings-panel">
                <div class="settings-panel-header">
                    <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                    <button class="close-settings-btn" @click="closeSettingsPanel">‚úï</button>
                </div>
                <div class="settings-panel-body">
                    <button class="settings-btn btn-reset" @click="showResetConfirmation" :disabled="state.faces.length === 0">
                        –ö—É–±–∏–∫ –æ–±–Ω—É–ª–∏—Å—å
                    </button>
                    <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ —Ñ–∞–π–ª -->
                    <button class="settings-btn" @click="loadDataFromFile">
                        –ö—É–±–∏–∫ —Ç–µ—Å—Ç (—Ñ–∞–π–ª)
                    </button>
                    <button class="settings-btn" @click="toggleEditMode">
                        <span v-if="!editMode">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞–Ω–∏</span>
                        <span v-else>OK</span>
                    </button>
                    <button class="settings-btn" @click="toggleDebugMode">
                        <span v-if="!state.debugMode">–í–∫–ª. –æ—Ç–ª–∞–¥–∫—É</span>
                        <span v-else>–í—ã–∫–ª. –æ—Ç–ª–∞–¥–∫—É</span>
                    </button>
                    <!-- –®–∞–≥ 3: –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –æ—Ç BLE —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ -->
                    <button class="settings-btn btn-summon" @click="disconnectBLE" :disabled="!bleManager || !state.bleConnected">
                        {{ state.bleConnected ? '–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è' : '–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è' }}
                    </button>
                </div>
            </div>
        </transition>

        <!-- –ü–∞–Ω–µ–ª—å "–ø–æ–¥–µ–ª–∏—Å—å" -->
        <transition name="slide-up">
            <div v-if="sharePanelVisible" class="settings-panel">
                <div class="settings-panel-header">
                    <h2>üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –¥–∞–Ω–Ω—ã–º–∏</h2>
                    <button class="close-settings-btn" @click="closeSharePanel">‚úï</button>
                </div>
                <div class="settings-panel-body">
                    <button class="settings-btn btn-share" @click="shareTxtReport" :disabled="state.faces.length === 0">
                        üìù –û—Ç–ø—Ä–∞–≤–∏—Ç—å TXT
                    </button>
                    <button class="settings-btn btn-share" @click="shareCsvReport" :disabled="state.faces.length === 0">
                        üìä –û—Ç–ø—Ä–∞–≤–∏—Ç—å CSV
                    </button>
                    <button class="settings-btn" @click="shareLogs">
                        üìã –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥–∏
                    </button>
                </div>
            </div>
        </transition>

        <!-- –ú–æ–¥–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–≤—ã–Ω–µ—Å–µ–Ω–∞ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –∫–∞—Ä—Ç–æ—á–µ–∫) -->
        <transition name="modal-fade">
            <div v-if="editingFaceId !== null" class="modal-backdrop" @click="closeEditForm">
                <div class="modal-edit-form" @click.stop>
                    <div class="edit-form-header">
                        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥—Ä–∞–Ω–∏ #{{ editingFaceId }}</h3>
                        <button class="close-btn" @click="closeEditForm">‚úï</button>
                    </div>
                    <div class="edit-form-body">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä–∞–Ω–∏:</label>
                        <input
                            type="text"
                            v-model="editFormData.customName"
                            placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ"
                            @keyup.enter="saveCustomName"
                            ref="editInput"
                        >
                        <div class="edit-form-actions">
                            <button class="btn-save" @click="saveCustomName">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <button class="btn-clear" @click="clearCustomName">–û—á–∏—Å—Ç–∏—Ç—å</button>
                            <button class="btn-cancel" @click="closeEditForm">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–±–Ω—É–ª–µ–Ω–∏—è -->
        <transition name="modal-fade">
            <div v-if="resetConfirmationVisible" class="modal-backdrop" @click="cancelReset">
                <div class="modal-edit-form" @click.stop>
                    <div class="edit-form-header">
                        <h3>‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–±–Ω—É–ª–µ–Ω–∏—è</h3>
                        <button class="close-btn" @click="cancelReset">‚úï</button>
                    </div>
                    <div class="edit-form-body">
                        <div class="reset-warning-message">
                            <p><strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞ —Ç–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥ –±—É–¥—É—Ç —Å–±—Ä–æ—à–µ–Ω—ã.</p>
                            <p>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
                            <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω—É–ª–∏—Ç—å –∫—É–±–∏–∫?</p>
                        </div>
                        <div class="edit-form-actions">
                            <button class="btn-save" @click="confirmReset">–î–∞, –æ–±–Ω—É–ª–∏—Ç—å</button>
                            <button class="btn-cancel" @click="cancelReset">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </div>
                </div>
            </div>
        </transition>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    // –®–∞–≥ 2: –î–æ–±–∞–≤–ª—è–µ–º BLE Manager –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                    bleManager: null,
                    state: {
                        faces: [],
                        currentFace: '',
                        currentFaceId: null,
                        extractionTime: '',
                        resetTime: 0,
                        rawData: '',
                        error: '',
                        debugMode: false,
                        // –°–æ—Å—Ç–æ—è–Ω–∏—è BLE –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                        bleLoading: false,
                        bleStatus: '', // '', 'connecting', 'connected', 'error'
                        bleConnected: false,
                        bleDeviceName: '',
                        bleDeviceInfo: '',
                        bleError: ''
                    },
                    storageAvailable: false,
                    STORAGE_KEY: 'cube_timer_state',
                    settingsPanelVisible: false,
                    sharePanelVisible: false,
                    editMode: false,
                    editingFaceId: null,
                    editFormData: {
                        customName: ''
                    },
                    resetConfirmationVisible: false
                };
            },
            mounted() {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å localStorage
                this.checkLocalStorageAvailable();

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
                if (this.storageAvailable) {
                    this.loadStateFromLocalStorage();
                }

                // –®–∞–≥ 2: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º BLE Manager
                this.initializeBleManager();
            },
            methods: {
                /**
                 * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç BLE Manager
                 */
                initializeBleManager() {
                    try {
                        if (typeof BleManager === 'undefined') {
                            console.warn('BleManager –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                            return;
                        }

                        this.bleManager = new BleManager();

                        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π BLE
                        this.bleManager.onConnectionChange = (connected) => {
                            this.state.bleConnected = connected;
                            this.state.bleStatus = connected ? 'connected' : '';
                            this.state.bleDeviceName = connected ?
                                (this.bleManager.device?.name || '–ë–µ–∑—ã–º—è–Ω–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ') : '';

                            if (connected) {
                                console.log('BLE –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                            } else {
                                console.log('BLE –æ—Ç–∫–ª—é—á–µ–Ω–æ');
                            }
                        };

                        this.bleManager.onError = (error) => {
                            this.state.bleError = error.message || String(error);
                            this.state.bleStatus = 'error';
                            this.state.bleLoading = false;
                            console.error('BLE –æ—à–∏–±–∫–∞:', error);
                        };

                        this.bleManager.onDataReceived = (data) => {
                            console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ BLE:', data);
                            // –î–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –º–µ—Ç–æ–¥–µ fetchDataFromBLE
                        };

                        console.log('BLE Manager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ BLE Manager:', error);
                        this.state.bleError = '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ BLE: ' + error.message;
                        this.state.bleStatus = 'error';
                    }
                },

                /**
                 * –®–∞–≥ 2: –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ BLE –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                 */
                async fetchDataFromBLE() {
                    if (!this.bleManager) {
                        this.initializeBleManager();
                        if (!this.bleManager) {
                            this.state.error = 'BLE Manager –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ bleManager.js';
                            return;
                        }
                    }

                    this.state.error = '';
                    this.state.bleLoading = true;
                    this.state.bleStatus = 'connecting';
                    this.state.bleError = '';

                    try {
                        console.log('–ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ BLE —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É...');

                        // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É
                        await this.bleManager.connect();

                        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
                        const status = this.bleManager.getConnectionStatus();
                        this.state.bleDeviceInfo = `–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${status.deviceName || '–ë–µ–∑ –∏–º–µ–Ω–∏'} (${status.deviceId?.substring(0, 8) || 'N/A'})`;

                        console.log('–ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å BLE —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞...');

                        // –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                        const data = await this.bleManager.readData();

                        // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Ñ–∞–π–ª—É data_from_cube.txt)
                        const textData = data.text;

                        if (!textData || textData.trim() === '') {
                            throw new Error('–ü–æ–ª—É—á–µ–Ω—ã –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞');
                        }

                        console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ—Ç BLE:', textData.substring(0, 100) + '...');

                        // –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ —Ç–∞–∫ –∂–µ, –∫–∞–∫ –∏ –∏–∑ —Ñ–∞–π–ª–∞
                        this.parseData(textData);

                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                        this.saveStateToLocalStorage();

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                        this.state.bleStatus = 'connected';
                        this.state.bleDeviceName = this.bleManager.device?.name || '–ö—É–±–∏–∫';

                        console.log('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã –∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã —á–µ—Ä–µ–∑ BLE');

                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ BLE:', error);
                        this.state.bleStatus = 'error';
                        this.state.bleError = error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ BLE';
                        this.state.error = '–û—à–∏–±–∫–∞ BLE: ' + error.message;

                        // –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                        setTimeout(() => {
                            if (confirm('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –∫—É–±–∏–∫—É. –•–æ—Ç–∏—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞?')) {
                                this.loadDataFromFile();
                            }
                        }, 500);

                    } finally {
                        this.state.bleLoading = false;
                    }
                },

                /**
                 * –®–∞–≥ 3: –û—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –æ—Ç BLE —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                 */
                async disconnectBLE() {
                    if (!this.bleManager || !this.state.bleConnected) {
                        return;
                    }

                    try {
                        await this.bleManager.disconnect();
                        this.state.bleConnected = false;
                        this.state.bleStatus = '';
                        this.state.bleDeviceName = '';
                        this.state.bleDeviceInfo = '';
                        console.log('–û—Ç–∫–ª—é—á–∏–ª–∏—Å—å –æ—Ç BLE —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞');
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –æ—Ç BLE:', error);
                        this.state.error = '–û—à–∏–±–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è: ' + error.message;
                    }
                },

                /**
                 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å localStorage
                 */
                checkLocalStorageAvailable() {
                    try {
                        const test = '__localStorage_test__';
                        localStorage.setItem(test, test);
                        localStorage.removeItem(test);
                        this.storageAvailable = true;
                    } catch (e) {
                        console.warn('localStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', e);
                        this.storageAvailable = false;
                    }
                },

                /**
                 * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ localStorage
                 */
                saveStateToLocalStorage() {
                    if (!this.storageAvailable) {
                        return;
                    }

                    try {
                        // –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é state –±–µ–∑ –ø–æ–ª—è error (–æ–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ)
                        const stateToSave = {
                            faces: this.state.faces,
                            currentFace: this.state.currentFace,
                            currentFaceId: this.state.currentFaceId,
                            extractionTime: this.state.extractionTime,
                            resetTime: this.state.resetTime,
                            rawData: this.state.rawData,
                            debugMode: this.state.debugMode
                        };

                        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(stateToSave));
                        console.log('State saved to localStorage:', stateToSave);
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', e);
                    }
                },

                /**
                 * –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ localStorage
                 */
                loadStateFromLocalStorage() {
                    if (!this.storageAvailable) {
                        return;
                    }

                    try {
                        const savedState = localStorage.getItem(this.STORAGE_KEY);

                        if (savedState) {
                            const parsedState = JSON.parse(savedState);

                            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                            this.state.faces = parsedState.faces || [];
                            this.state.currentFace = parsedState.currentFace || '';
                            this.state.currentFaceId = parsedState.currentFaceId || null;
                            this.state.extractionTime = parsedState.extractionTime || '';
                            this.state.resetTime = parsedState.resetTime || 0;
                            this.state.rawData = parsedState.rawData || '';
                            this.state.debugMode = parsedState.debugMode || false;

                            // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ —É –∫–∞–∂–¥–æ–π –≥—Ä–∞–Ω–∏ –µ—Å—Ç—å –∫–∞—Å—Ç–æ–º–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
                            this.state.faces.forEach((face, index) => {
                                if (!face.customName) {
                                    face.customName = `–ì—Ä–∞–Ω—å ${face.id || (index + 1)}`;
                                }
                            });

                            console.log('State loaded from localStorage:', parsedState);
                        }
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage:', e);
                    }
                },

                /**
                 * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Å—Ç—Ä–æ–∫—É –≤—Ä–µ–º–µ–Ω–∏ –≤ –º–∏–Ω—É—Ç—ã
                 * @param {string} timeStr - —Å—Ç—Ä–æ–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ "11 h 18 min", "15 min", "0 min" –∏–ª–∏ "0"
                 * @returns {number} –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω—É—Ç
                 */
                parseTimeToMinutes(timeStr) {
                    if (!timeStr || timeStr === '0') {
                        return 0;
                    }

                    let totalMinutes = 0;

                    // –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∞—Å—ã
                    const hoursMatch = timeStr.match(/(\d+)\s*h/);
                    if (hoursMatch) {
                        totalMinutes += parseInt(hoursMatch[1]) * 60;
                    }

                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –º–∏–Ω—É—Ç—ã
                    const minutesMatch = timeStr.match(/(\d+)\s*min/);
                    if (minutesMatch) {
                        totalMinutes += parseInt(minutesMatch[1]);
                    }

                    return totalMinutes;
                },

                /**
                 * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –º–∏–Ω—É—Ç—ã –≤ —Å—Ç—Ä–æ–∫—É —Ñ–æ—Ä–º–∞—Ç–∞ "X h Y min"
                 * @param {number} minutes - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω—É—Ç
                 * @returns {string} —Å—Ç—Ä–æ–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ "11 h 18 min" –∏–ª–∏ "15 min" –∏–ª–∏ "0 min"
                 */
                formatMinutesToString(minutes) {
                    if (minutes === 0) {
                        return '0 min';
                    }

                    const hours = Math.floor(minutes / 60);
                    const mins = minutes % 60;

                    if (hours > 0 && mins > 0) {
                        return `${hours} h ${mins} min`;
                    } else if (hours > 0) {
                        return `${hours} h 0 min`;
                    } else {
                        return `${mins} min`;
                    }
                },

                /**
                 * –í—ã—á–∏—Å–ª—è–µ—Ç —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É —Ç–µ–∫—É—â–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º –∏ –∑–Ω–∞—á–µ–Ω–∏–µ–º –ø—Ä–∏ —Å–±—Ä–æ—Å–µ
                 * @param {object} face - –æ–±—ä–µ–∫—Ç –≥—Ä–∞–Ω–∏ —Å –ø–æ–ª—è–º–∏ value –∏ resetValue
                 */
                calculateDelta(face) {
                    const currentMinutes = this.parseTimeToMinutes(face.value);
                    const resetMinutes = this.parseTimeToMinutes(face.resetValue);

                    face.deltaValueInt = currentMinutes - resetMinutes;
                    face.deltaValueIntStr = this.formatMinutesToString(face.deltaValueInt);
                },

                /**
                 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç —Ç–µ–∫—É—â–µ–π –≥—Ä–∞–Ω–∏
                 * @returns {object|null} –æ–±—ä–µ–∫—Ç –≥—Ä–∞–Ω–∏ –∏–ª–∏ null
                 */
                getCurrentFace() {
                    if (this.state.currentFaceId === null) return null;
                    return this.state.faces.find(f => f.id === this.state.currentFaceId) || null;
                },

                /**
                 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –≥—Ä–∞–Ω–∏
                 * @returns {string} –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä–∞–Ω–∏ (—Ç–æ–ª—å–∫–æ customName)
                 */
                getCurrentFaceDisplayName() {
                    const currentFace = this.getCurrentFace();
                    if (!currentFace) return '';
                    return currentFace.customName || `–ì—Ä–∞–Ω—å ${currentFace.id}`;
                },

                async loadDataFromFile() {
                    try {
                        this.state.error = '';
                        const response = await fetch('data_from_cube.txt');

                        if (!response.ok) {
                            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª data_from_cube.txt');
                        }

                        const content = await response.text();
                        this.parseData(content);

                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                        this.saveStateToLocalStorage();
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:', error);
                        this.state.error = '–û—à–∏–±–∫–∞: ' + error.message;
                    }
                },

                parseData(content) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    this.state.rawData = content;
                    this.state.extractionTime = new Date().toLocaleString('ru-RU');

                    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—É—â—É—é –≥—Ä–∞–Ω—å
                    const currentAgeMatch = content.match(/currentAge\s*=\s*([^.]+)/);
                    this.state.currentFace = currentAgeMatch ? currentAgeMatch[1].trim() : '';

                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –≥—Ä–∞–Ω–∏ –∏ –∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è
                    // –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞ –≥—Ä–∞–Ω–µ–π: –Ω–∞–∑–≤–∞–Ω–∏–µ = –≤—Ä–µ–º—è
                    const facePattern = /([–ê-–Ø–∞-—èA-Za-z]+)\s*=\s*(\d+\s*h?\s*\d*\s*min|\d+\s*min)/g;
                    const faces = [];
                    let match;
                    let id = 1;

                    while ((match = facePattern.exec(content)) !== null) {
                        const name = match[1].trim();
                        const value = match[2].trim();
                        
                        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º currentAge, –µ—Å–ª–∏ –æ–Ω –ø–æ–ø–∞–ª –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                        if (name !== 'currentAge') {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –≥—Ä–∞–Ω—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º (–¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è resetValue –∏ customName)
                            const existingFace = this.state.faces.find(f => f.name === name);

                            const face = {
                                id: id++,
                                name: name,
                                value: value,
                                resetValue: existingFace ? existingFace.resetValue : 0,
                                customName: existingFace ? existingFace.customName : null,
                                deltaValueInt: 0,
                                deltaValueIntStr: '0 min'
                            };

                            // –í—ã—á–∏—Å–ª—è–µ–º –¥–µ–ª—å—Ç—É
                            this.calculateDelta(face);

                            faces.push(face);
                        }
                    }

                    this.state.faces = faces;

                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º ID —Ç–µ–∫—É—â–µ–π –≥—Ä–∞–Ω–∏
                    if (this.state.currentFace) {
                        const currentFaceObj = this.state.faces.find(f => f.name === this.state.currentFace);
                        this.state.currentFaceId = currentFaceObj ? currentFaceObj.id : null;
                    } else {
                        this.state.currentFaceId = null;
                    }

                    console.log('Parsed data:', {
                        currentFace: this.state.currentFace,
                        currentFaceId: this.state.currentFaceId,
                        faces: this.state.faces,
                        extractionTime: this.state.extractionTime
                    });
                },

                showResetConfirmation() {
                    this.resetConfirmationVisible = true;
                },

                confirmReset() {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –æ–±–Ω—É–ª–µ–Ω–∏—è
                    this.state.resetTime = new Date().toLocaleString('ru-RU');

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ resetValue –¥–ª—è –∫–∞–∂–¥–æ–π –≥—Ä–∞–Ω–∏ –∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–µ–ª—å—Ç—É
                    this.state.faces.forEach(face => {
                        face.resetValue = face.value;
                        this.calculateDelta(face);
                    });

                    console.log('Cube reset:', {
                        resetTime: this.state.resetTime,
                        faces: this.state.faces
                    });

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞
                    this.saveStateToLocalStorage();

                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                    this.resetConfirmationVisible = false;
                },

                cancelReset() {
                    this.resetConfirmationVisible = false;
                },

                /**
                 * –û—Ç–∫—Ä—ã–≤–∞–µ—Ç/–∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫
                 */
                toggleSettingsPanel() {
                    this.settingsPanelVisible = !this.settingsPanelVisible;
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å "–ø–æ–¥–µ–ª–∏—Å—å" –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                    if (this.settingsPanelVisible) {
                        this.sharePanelVisible = false;
                    }
                },

                /**
                 * –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫
                 */
                closeSettingsPanel() {
                    this.settingsPanelVisible = false;
                    // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–∞–Ω–µ–ª–∏
                    if (this.editMode) {
                        this.editMode = false;
                        this.closeEditForm();
                    }
                },

                /**
                 * –û—Ç–∫—Ä—ã–≤–∞–µ—Ç/–∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–∞–Ω–µ–ª—å "–ø–æ–¥–µ–ª–∏—Å—å"
                 */
                toggleSharePanel() {
                    this.sharePanelVisible = !this.sharePanelVisible;
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ "–ø–æ–¥–µ–ª–∏—Å—å"
                    if (this.sharePanelVisible) {
                        this.settingsPanelVisible = false;
                    }
                },

                /**
                 * –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–∞–Ω–µ–ª—å "–ø–æ–¥–µ–ª–∏—Å—å"
                 */
                closeSharePanel() {
                    this.sharePanelVisible = false;
                },

                /**
                 * –í–∫–ª—é—á–∞–µ—Ç/–≤—ã–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥—Ä–∞–Ω–µ–π
                 */
                toggleEditMode() {
                    this.editMode = !this.editMode;
                    if (!this.editMode) {
                        this.closeEditForm();
                    }
                },

                /**
                 * –û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –≥—Ä–∞–Ω–∏
                 */
                openEditForm(face) {
                    if (!this.editMode) return;

                    this.editingFaceId = face.id;
                    this.editFormData.customName = face.customName || '';

                    // –§–æ–∫—É—Å–∏—Ä—É–µ–º –∏–Ω–ø—É—Ç –ø–æ—Å–ª–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞
                    this.$nextTick(() => {
                        if (this.$refs.editInput) {
                            this.$refs.editInput.focus();
                        }
                    });
                },

                /**
                 * –ó–∞–∫—Ä—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                 */
                closeEditForm() {
                    this.editingFaceId = null;
                    this.editFormData.customName = '';
                },

                /**
                 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—É—é –≥—Ä–∞–Ω—å
                 */
                getEditingFace() {
                    if (this.editingFaceId === null) return null;
                    return this.state.faces.find(f => f.id === this.editingFaceId);
                },

                /**
                 * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä–∞–Ω–∏
                 */
                saveCustomName() {
                    if (this.editingFaceId === null) return;

                    const face = this.state.faces.find(f => f.id === this.editingFaceId);
                    if (face) {
                        const newCustomName = this.editFormData.customName.trim();
                        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–ª –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
                        face.customName = newCustomName || `–ì—Ä–∞–Ω—å ${face.id}`;
                        this.saveStateToLocalStorage();
                        console.log('Custom name saved:', face);
                    }

                    this.closeEditForm();
                },

                /**
                 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –≥—Ä–∞–Ω–µ–π
                 */
                generateTxtReport() {
                    if (this.state.faces.length === 0) {
                        return '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏';
                    }

                    let report = 'Cube Timer - –û—Ç—á–µ—Ç\n';
                    report += '==================\n\n';

                    const currentFace = this.getCurrentFace();
                    if (currentFace) {
                        report += `üìç –¢–µ–∫—É—â–∞—è –≥—Ä–∞–Ω—å: ${this.getCurrentFaceDisplayName()}\n`;
                        report += `   –í—Ä–µ–º—è: ${currentFace.deltaValueIntStr}\n`;
                    }

                    report += `üïí –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${this.state.extractionTime}\n`;

                    if (this.state.resetTime !== 0) {
                        report += `üîÑ –í—Ä–µ–º—è –æ–±–Ω—É–ª–µ–Ω–∏—è: ${this.state.resetTime}\n`;
                    }

                    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–ø–æ—Å–æ–±–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
                    if (this.state.bleDeviceName) {
                        report += `üì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${this.state.bleDeviceName}\n`;
                    }

                    report += '\nüìä –ì—Ä–∞–Ω–∏:\n';
                    this.state.faces.forEach(face => {
                        report += `  ${face.id} - ${face.customName}: ${face.deltaValueIntStr}\n`;
                        if (this.state.debugMode) {
                            report += `    (ID: ${face.id}, –ó–Ω–∞—á–µ–Ω–∏–µ: ${face.value})\n`;
                        }
                    });

                    return report;
                },

                /**
                 * –ü–∞—Ä—Å–∏—Ç —Å—Ç—Ä–æ–∫—É –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ "dd.mm.yyyy, hh:mm:ss" –≤ –æ–±—ä–µ–∫—Ç Date
                 * @param {string} dateStr - —Å—Ç—Ä–æ–∫–∞ —Å –¥–∞—Ç–æ–π
                 * @returns {Date|null} –æ–±—ä–µ–∫—Ç Date –∏–ª–∏ null –ø—Ä–∏ –æ—à–∏–±–∫–µ
                 */
                parseDateString(dateStr) {
                    if (!dateStr || dateStr === 0) return null;

                    try {
                        // –§–æ—Ä–º–∞—Ç: "22.05.2024, 15:30:25"
                        const parts = dateStr.split(/[\s,]+/);
                        if (parts.length < 2) return null;

                        const dateParts = parts[0].split('.');
                        const timeParts = parts[1].split(':');

                        if (dateParts.length !== 3 || timeParts.length !== 3) return null;

                        return new Date(
                            parseInt(dateParts[2], 10),  // –≥–æ–¥
                            parseInt(dateParts[1], 10) - 1, // –º–µ—Å—è—Ü (0-based)
                            parseInt(dateParts[0], 10),  // –¥–µ–Ω—å
                            parseInt(timeParts[0], 10),  // —á–∞—Å—ã
                            parseInt(timeParts[1], 10),  // –º–∏–Ω—É—Ç—ã
                            parseInt(timeParts[2], 10)   // —Å–µ–∫—É–Ω–¥—ã
                        );
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã:', error);
                        return null;
                    }
                },

                /**
                 * –í—ã—á–∏—Å–ª—è–µ—Ç —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É –¥–≤—É–º—è –¥–∞—Ç–∞–º–∏ –≤ –º–∏–Ω—É—Ç–∞—Ö
                 * @param {Date} date1 - –ø–µ—Ä–≤–∞—è –¥–∞—Ç–∞
                 * @param {Date} date2 - –≤—Ç–æ—Ä–∞—è –¥–∞—Ç–∞
                 * @returns {number} —Ä–∞–∑–Ω–∏—Ü–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö
                 */
                getDateDiffInMinutes(date1, date2) {
                    if (!date1 || !date2) return 0;
                    const diffMs = Math.abs(date2 - date1);
                    return Math.round(diffMs / (1000 * 60));
                },

                /**
                 * –≠–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è CSV (–æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –≤ –∫–∞–≤—ã—á–∫–∏ –µ—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–ø—è—Ç—É—é –∏–ª–∏ –∫–∞–≤—ã—á–∫–∏)
                 * @param {string} value - –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                 * @returns {string} —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                 */
                escapeCsvValue(value) {
                    if (value === null || value === undefined) return '';
                    const stringValue = String(value);

                    // –ï—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–ø—è—Ç—É—é, –∫–∞–≤—ã—á–∫—É –∏–ª–∏ –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏ - –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ –∫–∞–≤—ã—á–∫–∏
                    if (/[,"\n\r]/.test(stringValue)) {
                        return '"' + stringValue.replace(/"/g, '""') + '"';
                    }
                    return stringValue;
                },

                /**
                 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç CSV –æ—Ç—á–µ—Ç –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –≥—Ä–∞–Ω–µ–π –≤ –Ω–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
                 * –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞: –∑–∞–≥–æ–ª–æ–≤–∫–∏
                 * –í—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞: –¥–∞–Ω–Ω—ã–µ
                 */
                generateCsvReport() {
                    if (this.state.faces.length === 0) {
                        return '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏';
                    }

                    // –ü–∞—Ä—Å–∏–º –¥–∞—Ç—ã –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ä–∞–∑–Ω–∏—Ü—ã
                    const resetDate = this.parseDateString(this.state.resetTime);
                    const extractionDate = this.parseDateString(this.state.extractionTime);
                    const workTimeMinutes = this.getDateDiffInMinutes(resetDate, extractionDate);

                    // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –∏–∑ 6 –≥—Ä–∞–Ω–µ–π –≤ –ø–æ—Ä—è–¥–∫–µ id
                    const orderedFaces = [];
                    for (let i = 1; i <= 6; i++) {
                        const face = this.state.faces.find(f => f.id === i);
                        orderedFaces.push(face || null);
                    }

                    // 1. –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
                    const headers = [
                        '–í—Ä–µ–º—è –æ–±–Ω—É–ª–µ–Ω–∏—è',
                        '–í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è',
                        '–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã (–º–∏–Ω)'
                    ];

                    // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –≥—Ä–∞–Ω–µ–π
                    orderedFaces.forEach((face, index) => {
                        const faceNumber = index + 1;
                        let faceName = `–ì—Ä–∞–Ω—å${faceNumber}`;

                        if (face) {
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –∫–∞—Å—Ç–æ–º–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
                            faceName += `: ${face.customName}`;
                        }

                        headers.push(faceName);
                    });

                    // 2. –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
                    const data = [
                        this.state.resetTime !== 0 ? this.state.resetTime : '',
                        this.state.extractionTime,
                        workTimeMinutes
                    ];

                    // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞–Ω–µ–π (–∞–∫—Ç–∏–≤–Ω–æ–µ –≤—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç–∞—Ö)
                    orderedFaces.forEach(face => {
                        if (face) {
                            data.push(face.deltaValueInt);
                        } else {
                            data.push(''); // –ü—É—Å—Ç–∞—è –∫–æ–ª–æ–Ω–∫–∞ –¥–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–π –≥—Ä–∞–Ω–∏
                        }
                    });

                    // 3. –°–æ–±–∏—Ä–∞–µ–º CSV —Å—Ç—Ä–æ–∫—É
                    const escapedHeaders = headers.map(h => this.escapeCsvValue(h));
                    const escapedData = data.map(d => this.escapeCsvValue(d));

                    return escapedHeaders.join(',') + '\n' + escapedData.join(',');
                },

                /**
                 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ TXT —á–µ—Ä–µ–∑ Web Share API
                 */
                async shareTxtReport() {
                    const report = this.generateTxtReport();

                    if (navigator.share) {
                        try {
                            await navigator.share({
                                title: 'Cube Timer Report',
                                text: report
                            });
                            console.log('TXT report shared successfully');
                        } catch (error) {
                            if (error.name !== 'AbortError') {
                                this.copyToClipboard(report, 'TXT');
                            }
                        }
                    } else {
                        this.copyToClipboard(report, 'TXT');
                    }

                    this.closeSharePanel();
                },

                /**
                 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV —á–µ—Ä–µ–∑ Web Share API
                 */
                async shareCsvReport() {
                    const report = this.generateCsvReport();

                    if (navigator.share) {
                        try {
                            await navigator.share({
                                title: 'Cube Timer Report (CSV)',
                                text: report
                            });
                            console.log('CSV report shared successfully');
                        } catch (error) {
                            if (error.name !== 'AbortError') {
                                this.copyToClipboard(report, 'CSV');
                            }
                        }
                    } else {
                        this.copyToClipboard(report, 'CSV');
                    }

                    this.closeSharePanel();
                },

                /**
                 * –ö–æ–ø–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
                 */
                copyToClipboard(text, format) {
                    navigator.clipboard.writeText(text).then(() => {
                        alert(`${format} –æ—Ç—á–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!`);
                    }).catch(err => {
                        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—É—Ñ–µ—Ä:', err);
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é:\n\n' + text);
                    });
                },

                /**
                 * –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–æ–≤
                 */
                shareLogs() {
                    alert('–§—É–Ω–∫—Ü–∏—è "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥–∏" –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –õ–æ–≥–∏ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏.');
                    console.log('Logs requested:', {
                        state: this.state,
                        storageAvailable: this.storageAvailable,
                        currentTime: new Date().toLocaleString()
                    });
                    this.closeSharePanel();
                },

                /**
                 * –û—á–∏—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä–∞–Ω–∏ (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ)
                 */
                clearCustomName() {
                    if (this.editingFaceId === null) return;

                    const face = this.state.faces.find(f => f.id === this.editingFaceId);
                    if (face) {
                        face.customName = `–ì—Ä–∞–Ω—å ${face.id}`;
                        this.saveStateToLocalStorage();
                        console.log('Custom name cleared, restored default:', face);
                    }

                    this.closeEditForm();
                },

                /**
                 * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏
                 */
                toggleDebugMode() {
                    this.state.debugMode = !this.state.debugMode;
                    this.saveStateToLocalStorage();
                    console.log('Debug mode:', this.state.debugMode);
                }
            }
        }).mount('#app');
    </script>

    <style>
        /* –®–∞–≥ 4: –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è BLE */
        .connection-status {
            padding: 10px 15px;
            margin: 0 var(--spacing-md) var(--spacing-md);
            border-radius: var(--radius-md);
            text-align: center;
            font-size: 0.9rem;
            font-weight: bold;
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-normal);
        }

        .status-connecting {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            animation: pulse 1.5s infinite;
        }

        .status-connected {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
        }

        .status-error {
            background: linear-gradient(135deg, #ff6b6b 0%, #d32f2f 100%);
            color: white;
            animation: shake 0.5s ease;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</body>
</html>